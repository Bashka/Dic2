Объекты и классы.
Конструктор класса
==================

В Perl класс представляется обычным пакетом, все функции которого являются методами класса, а имя пакета соответствует имени класса.

Для создания объекта класса необходимо реализовать обязательный метод - конструктор. Данный метод может называться как угодно, но он должен создавать и возвращать специальную объектную ссылку этого класса, представляющую собой объект.

Для создания объектной ссылки используется функция:

    bless(<ссылкаНаХэш>, <имяКласса>);

Здесь в качестве "ссылкиНаХэш" используется ссылка на обычный хэш Perl, представляющий собой будущий объект с установленными свойствами. "имяКласса" позволяет функции bless связать эту ссылку с конкретным классом (пакетом) так, чтобы при вызове методов у этого объекта Perl знал в каком классе (пакете) эти методы следует искать.

Важно помнить, что любую функцию пакета можно вызывать следующими требя способами:

1. `<имяПакета>::<имяФункции>()` - классический вызов функции;
1. `<имяПакета>-><имяФункции>()` - вызов функции как статического метода класса;
1. `<имяФункции> <имяПакета>()` - вызов функции как статического метода класса.

Второй и третий способ передают в функцию в качестве первого аргумента имя класса, что и позволяет создавать конструктор объектов. Простейший конструктор имеет вид:

    package MyClass;
    sub new(){ # Имя может быть любым.
      my $class = shift(@_); # Получаем имя класса.
      $class = ref($class) || $class; # Если конструктор класса вызван через объект (new $obj()) получаем имя класса, иначе оставляем все как есть.
      my $obj = {'свойство' => 'значение', ..., @_}; # Создаем будущий объект в виде хэша и определяем для него свойства со значениями по умолчанию. Конкатенируем его с параметрами конструктора что даст возможность задать значения свойств объекта через конструктор (new MyClass('a' => 1)).
      return bless($obj, $class); # Создание объектной ссылки и возврат объекта.
    }

Вызвать такой конструктор можно тремя различными способами:

1. Как статичный метод класса - MyClass->new();
1. Как оператор - new MyClass();
1. Как метод объекта того же класса - $obj->new().

Методы класса
=============

Все функции, объявленные в классе (пакете) считаются его методами. Любой метод можно вызвать от имени класса (класс->метод()) как его статичный метод, при этом в качестве первого параметра метода будет передано имя класса; так и от имени объекта этого класса ($объект->метод()) как его метод-член, при этом в качестве первого параметра метода будет передана ссылка на этот объект.

Ниже приведен пример реализации метода getA, возвращающего значение свойства 'a' экземпляра класса, для класса MyClass:

    sub getA(){
      return $_[0]->{'a'}; # В первом параметре функции ($_[0]) находится объект-ссылка, от имени которой вызывается данный метод.
    }

Ниже приведен пример использования класса MyClass, рассмотренного ранее:

    use MyClass;
    $obj = new MyClass('a' => 1);
    print $obj->getA(); # Предполагается что метод getA реализован в классе и возвращает значение свойства a.

Метод так же можно вызвать через переменную:

    my $m = 'getA';
    $obj->$m(); # Вызов метода getA.

Деструктор
==========

Метод DESTROY является деструктором объекта и вызывается перед удалением объектной ссылки. Ниже приведен пример реализации деструктора объекта:

    sub DESTROY{
      print 'Объект уничтожен';
    }

Свойства класса и типизация
===========================

Прагма fields позволяет создавать более удобные объектные ссылки, чем функция bless. Во-первых создаваемые ей объектные ссылки имеют меньший объем, чем обычные хэши, а во-вторых Perl может следить за доступом к свойствам таких объектов на этапе компиляции, то есть предотвращать доступ к свойствам, не объявленным для объекта. Ниже приведен конструктор класса, использующего fields:

    package MyClass;
    use fields(<свойство>, ...);
    sub new(){
      my $class = shift(@_); # Получаем имя класса.
      $class = ref($class) || $class; # Если конструктор класса вызван через объект (new $obj()) получаем имя класса, иначе оставляем все как есть.
      my MyClass $obj = fields::new($class); # Создание объекта с помощью fields.
      my $prop = {@_}; # Воспринять оставшиеся в параметрах данные как хэш-таблицу.
      $obj->{<свойство>} = $prop->{<свойство>} || <значениеПоУмолчанию>; # Установка значений по умолчанию для объекта.
      return $obj; # Возврат полученного объекта.
    }

Как видно из примера, для создания объектной ссылки не используется функция bless, а применяется метод new пакета fields. Так же разрешено типизировать переменные (my <класс> $<переменная>), что сообщает Perl о том, какой класс используется и позволяет контролировать доступ к свойствам объекта на этапе компиляции. Ниже приведен пример этого:

    my MyClass $obj = new MyClass();
    print $obj->{'c'}; # Предполагается что свойство 'c' не определено для класса MyClass. При этом будет выброшено исключение, информирующее о том, что в классе MyClass, свойство 'c' отсутствует.

Важно помнить, что при использовании fields, наследование возможно только с помощью прагмы use base.
