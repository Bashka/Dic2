Сетевой уровень
Задачи
======

Сетевой уровень отвечает за передачу данных между узлами, которые могут находится в разных сетях (логические сети, определяемые маской подсети), а так же за маршрутизацию данных по каналам связи, обеспечивая снижение нагрузки на эти каналы и большую безопасность.

Адресация
=========

Сетевой уровень использует адреса узлов и сетей, в которых они находятся, через один универсальный адрес, называемый IP-адресом или просто IP.

IP представляет собой четыре 1 байтовых числа, определяющие как сеть, к которой относится узел, так и сам узел в этой сети. Для отделения байтов, определяющих сеть в IP от байтов, определяющих узел в этой сети, используется специальная 4 байтовая маска, называемая маской подсети. Цифрами 255 определяются байты, описывающие сеть, а цифрами 0 байты, описывающие узел сети.

Ниже приведен пример IP-адреса и маски подсети:

    192.168.0.1
    255.255.255.0

Данный адрес определяет узел с номером 1 в сети 192.168.0. Маска подсети (255.255.255.0) определяет, что первые 3 байта описывают сеть узла, а последний байт определяет номер самого узла.

В IP адресации существует несколько специальных адресов:

* 255.255.255.255 - все узлы сети, входящие в ту же сеть, что и узел, отправляющий пакет; 
* сеть.255 - все узлы заданной "сети" (на пример 192.168.0.255);
* 0.0.0.0 - пакет без адресата, что означает 'любой узел в любой сети'. Предполагается, что адресация выполняться через канальный уровень;
* сеть.0 - пакет без адресата, что означает 'любой узел в указанной "сети"'. Предполагается, что адресация выполняться через канальный уровень.

Маршрутизация
=============

Для маршрутизации пакетов по сети используется простой алгоритм, согласно которому каждому конкретному узлу необходимо лишь знать в какой сетевой интерфейс (порт) передать пакет, о его дальнейшей судьбе узлы заботится не надо. Для этого используются специальные таблицы маршрутизации. Пример такой таблицы приведен ниже:

| Целевой узел | Шлюз | Маска подсети целевого узла | Флаг | Приоритет | Сетевой интерфейс |
|--------------|------|-----------------------------|------|-----------|-------------------|
|local         |*     |255.255.0.0                  |U     |1000       |eth0               |
|192.168.1.0   |*     |255.255.255.0                |U     |2          |eth0               |
|0.0.0.0       |192.168.1.1 |255.255.255.0          |UG    |0          |wlan0              |

Данная таблица описывает следующие правила:

1. В первой строке определена передача всех пакетов для сети 127.0.0.0 (локальная петля) в интерфейс eth0;
2. Во второй строке определена передача всех пакетов для локальной сети 192.168.1.0 так же в интерфейс eth0;
3. В третьей строке определена передача всех остальных пакетов, не относящихся к локальной сети, в интерфейс беспроводной связи wlan0.

Ниже приведено описание каждого поля этой таблицы:

* Целевой узел (default) - IP-адрес узла или сеть, к которому может быть передан пакет;
* Шлюз (gateway) - IP-адрес маршрутизатора, который используется для связи локальной сети, из которой передается узел с сетью, в которой находится целевой узел;
* Маска подсети (genmask) - маска подсети, используемая для определения подсети, к которой относится целевой узел;
* Флаг (flags) - специальные флаги, используемые узлом для определения типа перехода (переход без использования шлюза или с ним);
* Приоритет (metric) - целочисленная величина, определяющая приоритет данной записи. Чем больше это значение, тем приоритетнее данный переход;
* Сетевой интерфейс (iface) - имя сетевого интерфейса (порта), в который необходимо передать пакет, если он соответствует заданной записи.

Пакет
=====

Единицей данных на сетевом уровне является пакет. Его заголовок имеет следующую структуру:

| № п/п слова |      Наименование       | Размер (байт) | Описание                                                                                                                                                              |
|-------------|-------------------------|---------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|1            |Номер версии             |0.5            |Версия протокола (IPv4 или IPv6)                                                                                                                                       |
|1            |Длина заголовка          |0.5            |Общая длина заговолка. Заголовок IP пакета состоит из 4 байтовых блоков (слов). Минимальное число слов в заголовке 5 (20 байт), а максимальное 15 (60 байт)            |
|1            |Тип сервиса              |1              |Усторевшее поле, используемое ранее для записи информации о применяемом классе обслуживания пакета                                                                     |
|1            |Общая длина              |2              |Общая длина пакета с учетом заголовка и данных. Значение этого поля не может превышать 65535 байт                                                                      |
|2            |Идентификатор пакета     |2              |Специальное значение, позволяющее протоколу определить, к какому потоку данных относится данный пакет. Все пакеты одного потока имели одинаковый идентификатор         |
|2            |Флаги D и M              |3 бита         |Первый бит этого поля не используется. Флаг D со значением 1 запрещает фрагментацию пакета, в то время как флаг M со значением 0 идентифицирует последний пакет        |
|2            |Смещение фрагмета        |13 бит         |Позиция в байтах данного фрагмента пакета относительно всего (фрагментированного) потока. Всего может быть не более 8192 фрагментов                                    |
|3            |Время жизни              |1              |Число переходов пакета между узлами. На каждом узле это значение уменьшается на 1 и если оно станет равным 0, пакет считается потерянным, о чем сообщается отправителю |
|3            |Протокол верхнего уровня |1              |Определение протокола более верхнего уровня, которому предназначается пакет (это могут быть протоколы транспортного уровня TCP или UDP)                                |
|3            |Контрольная сумма        |2              |Контрольная сумма, используемая для контроля целостности заголовка (но не всего пакета) и рассчитываемая на каждом узле (так как поле 'время жизни' изменяется)        |
|4            |IP-адрес источника       |4              |IP-адрес узла, передающего пакет                                                                                                                                       |
|4            |IP-адрес назначения      |4              |IP-адрес узла адресата                                                                                                                                                 |
|5            |Параметры и выравнивание |Переменный     |Другие слова заголовка                                                                                                                                                 |

Оборудование
============

На сетевом уровне функционирует следующее оборудование:

Маршрутизатор
-------------

Маршрутизатор представляет собой логическое устройство с несколькими сетевыми интерфейсами. Оно использует алгоритм маршрутизации и таблицу маршрутов для передачи входящих пакетов в нужные сетевые интерфейсы. Оно функционирует следующим образом:

1. При запуске маршрутизатор сообщает о себе информацию с помощью специальных пакетов, которыми обмениваются все маршрутизаторы в соответствии с используемым алгоритмом маршрутизации. Этот процесс называется 'настройкой' и служит для построения таблицы маршрутов;
2. При получении пакета маршрутизатор с помощью таблицы маршрутизации определяет сетевой интерфейс, в который необходимо переслать пакет.

В отличии от сетевых коммутаторов, маршрутизаторы передают пакеты только адресату или другому маршрутизатору, что увеличивает безопасность сети и не нагружает канал.

Маршрутизаторы используются для объединения нескольких подсетей в одну сеть.

Маршрутизаторы часто дополняются сервисами прикладного уровня, такими как DHCP, NAT и так далее.
